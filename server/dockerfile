# Usa a versão mais leve do Node.js
FROM node:20-slim

WORKDIR /usr/src/app

# Copia apenas arquivos essenciais primeiro (para melhor cache)
COPY package*.json ./
RUN npm install --frozen-lockfile

# Copia o restante do código
COPY . .

# Garante que a pasta do Prisma existe
RUN mkdir -p /usr/src/app/prisma 

# Gera os arquivos do Prisma
RUN npx prisma generate

# Evita reinstalação desnecessária do bcrypt (e outras libs nativas)
RUN npm rebuild bcrypt

# Compila o código
RUN npm run build

# Expõe a porta do servidor
EXPOSE 3020

# Comando final (roda migrations antes de iniciar)
CMD ["sh", "-c", "npx prisma db push && npm start"]
